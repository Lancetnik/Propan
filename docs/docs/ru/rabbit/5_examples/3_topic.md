# Topic Exchange

**Topic** Exchange - мощный механизм маршрутизации *RabbitMQ*. Данный тип `exchange` отправляет сообщения в очереди в соответсвии с *паттерном*,
указанном при их подключении к `exchange` и `routing_key` самого сообщения.

При этом, если очередь слушает несколько потребителей, сообщения все также будут распределяться между ними.

## Пример

```python linenums="1"
{!> docs_src/rabbit/topic.py !}
```

### Объявление потребителей

Для начала мы объявили наш **Topic** exchange и несколько очередей, которые будут его слушать:

```python linenums="8" hl_lines="1 3-4"
{!> docs_src/rabbit/topic.py [ln:8-11]!}
```

При этом в `routing_key` наших очередей мы указываем *паттерн* ключей маршрутизации, которые будут обрабатываться этой очередью.

Затем мы подписали несколько потребителей с помощью объявленных очередей на созданный нами `exchange`

```python linenums="13" hl_lines="1 5 9"
{!> docs_src/rabbit/topic.py [ln:13-23]!}
```

!!! note
    Обратите внимание, что `handler1` и `handler2` подписаны на один `exchange` с помощью одной и той же очереди:
    в рамках одного сервиса это не имеет смысла, так как сообщения будут приходить в эти обработчики поочередно.
    Здесь мы эмулируем работу несколько потребителей и балансировку нагрузки между ними.

### Распределение сообщений

Теперь распределение сообщений между этими потребителями будет выглядеть следующим образом:

```python
{!> docs_src/rabbit/topic.py [ln:27]!}
```

Сообщение `1` будет отправлено в `handler1`, т.к. он слушает `exchange` с помощью очереди с ключом маршрутизации `*.info`

---

```python
{!> docs_src/rabbit/topic.py [ln:28]!}
```

Сообщение `2` будет отправлено в `handler2`, т.к. он слушает `exchange` с помощью той же очереди, но `handler1` занят

---

```python
{!> docs_src/rabbit/topic.py [ln:29]!}
```

Сообщение `3` снова будет отправлено в `handler1`, т.к. он освободился на данный момент

---

```python
{!> docs_src/rabbit/topic.py [ln:30]!}
```

Сообщение `4` будет отправлено в `handler3`, т.к. он единственный слушает `exchange` с помощью очереди с ключом маршрутизации `*.debug`
